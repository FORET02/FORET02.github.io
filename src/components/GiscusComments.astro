---
const repo = import.meta.env.PUBLIC_GISCUS_REPO;
const repoId = import.meta.env.PUBLIC_GISCUS_REPO_ID;
const category = import.meta.env.PUBLIC_GISCUS_CATEGORY;
const categoryId = import.meta.env.PUBLIC_GISCUS_CATEGORY_ID;

const giscusLang = "en";
---

<section class="giscus-wrap">
  <div
    id="giscus_thread"
    data-repo={repo}
    data-repo-id={repoId}
    data-category={category}
    data-category-id={categoryId}
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-lang={giscusLang}
    data-loading="lazy"
  ></div>
</section>

<script is:inline>
  (() => {
    const host = document.getElementById("giscus_thread");
    if (!host) return;

    const cfg = {
      repo: host.getAttribute("data-repo") || "",
      repoId: host.getAttribute("data-repo-id") || "",
      category: host.getAttribute("data-category") || "",
      categoryId: host.getAttribute("data-category-id") || "",
      mapping: host.getAttribute("data-mapping") || "pathname",
      strict: host.getAttribute("data-strict") || "0",
      reactionsEnabled: host.getAttribute("data-reactions-enabled") || "1",
      emitMetadata: host.getAttribute("data-emit-metadata") || "0",
      inputPosition: host.getAttribute("data-input-position") || "top",
      lang: host.getAttribute("data-lang") || "en",
      loading: host.getAttribute("data-loading") || "lazy",
    };

    function isDarkMode() {
      return document.documentElement.classList.contains("dark-mode");
    }

    function getGiscusTheme() {
      return isDarkMode() ? "dark_dimmed" : "light";
    }

    function postConfigToGiscus() {
      const iframe = document.querySelector("iframe.giscus-frame");
      if (!iframe) return false;

      iframe.contentWindow?.postMessage(
        {
          giscus: {
            setConfig: {
              theme: getGiscusTheme(),
              lang: cfg.lang, 
            },
          },
        },
        "https://giscus.app"
      );
      return true;
    }

    function retryPostConfig(tries = 25) {
      if (postConfigToGiscus()) return true;
      if (tries <= 0) return false;
      setTimeout(() => retryPostConfig(tries - 1), 200);
      return false;
    }

    function clearGiscus() {
      host.innerHTML = "";
      const oldFrame = document.querySelector("iframe.giscus-frame");
      if (oldFrame) oldFrame.remove();
    }

    function mountGiscus() {
      clearGiscus();

      const s = document.createElement("script");
      s.src = "https://giscus.app/client.js";
      s.async = true;
      s.crossOrigin = "anonymous";

      s.setAttribute("data-repo", cfg.repo);
      s.setAttribute("data-repo-id", cfg.repoId);
      s.setAttribute("data-category", cfg.category);
      s.setAttribute("data-category-id", cfg.categoryId);

      s.setAttribute("data-mapping", cfg.mapping);
      s.setAttribute("data-strict", cfg.strict);
      s.setAttribute("data-reactions-enabled", cfg.reactionsEnabled);
      s.setAttribute("data-emit-metadata", cfg.emitMetadata);
      s.setAttribute("data-input-position", cfg.inputPosition);

      s.setAttribute("data-lang", "en");

      s.setAttribute("data-loading", cfg.loading);

      s.setAttribute("data-theme", getGiscusTheme());

      host.appendChild(s);

      retryPostConfig();

      setTimeout(() => retryPostConfig(), 1200);
    }

    mountGiscus();

    document.addEventListener("astro:page-load", () => {
      mountGiscus();
    });

    const obs = new MutationObserver(() => {
      retryPostConfig();
    });

    obs.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });

    window.addEventListener("foret:theme-change", () => retryPostConfig());
  })();
</script>

<style>
  .giscus-wrap {
    margin-top: 3rem;
    padding-top: 2rem;
  }
</style>
